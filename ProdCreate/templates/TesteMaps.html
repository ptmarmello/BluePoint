<DOCTYPE html>
  <html lang="pt-br">
  <head>
    <title>Map that Leads to you</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

    <style type="text/css">
      #mapInst{
        height: 100%;
        width: 100%;
      }
    </style>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
  </head>
  <body>


    <div id="mapInst"></div>

    <script>

  var mymap = L.map('mapInst').locate({setView:true,maxZoom:16});

  var cpos;

  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
    maxZoom: 22,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
      '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/streets-v11'
  }).addTo(mymap);

  // (1.0) ########## Lista ########## //
  var lista = localStorage.getItem('lista') ? JSON.parse(localStorage.getItem('lista')) : [];
  var locais_entrados = localStorage.getItem('local') ? JSON.parse(localStorage.getItem('local')) : [];
  var i = 0;

  // (1.1) ########## DESENHANDO MARCAÇÃO AO CARREGAR A PÁGINA ########## //
  function onLoading() {
    for (i = 0; i < lista.length; i++) {
      L.marker(lista[i]).addTo(mymap)
        .bindPopup("<b>Zona segura</b>").openPopup();

      L.circle(lista[i], 200, {
        color: 'green',
        fillColor: 'green',
        fillOpacity: 0.3
      }).addTo(mymap).bindPopup("<b>Dentro <strong>da</strong> zona de segurança.</b><br/>");
    }
  }
  window.onload = onLoading;

  // (2.0) ########## PIN DO GPS ########## //
  var LeafIcon = L.Icon.extend({
    options: {
      iconSize: [25, 25], // size of the icon
      iconAnchor: [12, 12], // point of the icon which will correspond to marker's location
      popupAnchor: [0, 0] // point from which the popup should open relative to the iconAnchor
    }
  });

  var blueIcon = new LeafIcon({ iconUrl: 'https://i.ibb.co/Ws9tLdY/blue-dot-icon.png' });

  // (2.1) ########## GEOLOCALIZAÇÃO ########## //
  var current_position;

  function onLocationFound(e) {

    if (current_position) {
      var radius = e.accuracy;
      mymap.removeLayer(current_position);
    }

    layer = L.marker(e.latlng, { icon: blueIcon }).addTo(mymap)
    current_position = L.marker(e.latlng, { icon: blueIcon }).addTo(mymap)
    cpos = e.latlng
  }

  // (2.2) ########## ALERTA DE ERRO CASO A GEOLOCALIZAÇÃO NÃO FUNCIONE ########## //
  function onLocationError(e) {
    alert(e.message);
  }

  mymap.on('locationerror', onLocationError);
  mymap.on('locationfound', onLocationFound);

  function mapaData() {
    L.marker(e.latlng).addTo(mymap)
      .bindPopup("<b>Zona segura</b>").openPopup();

    L.circle(e.latlng, 200, {
      color: 'green',
      fillColor: 'green',
      fillOpacity: 0.3
    }).addTo(mymap).bindPopup("<b>Dentro <strong>da</strong> zona de segurança.</b><br/>");
  }


  // (2.3) ########## USUÁRIO DENTRO OU FORA DA ZONA SEGURA ########## //
  allow_locating = false;
  locating = false;

  localizar = function () {
    if (!allow_locating) { return }
    if (locating) { return }

    console.log(177, 'locating', locating, lista, lista.length);
    locating = true;

    for (i = 0; i < lista.length; i++) {
      console.log(183, i);
      local_atual = lista[i];
      console.log(175, cpos, cpos.distanceTo(local_atual));

      if (cpos.distanceTo(local_atual) <= "200") {
        console.log(178, "Você está DENTRO de uma zona segura", local_atual);
        // adicionar_entrada2(local_atual);
        cor_desprotegido();
      }
      else {
        console.log(183, "você está FORA de uma zona segura");
        // adicionar_saida(local_atual);
        cor_protegido();
      }
    }

    layer.remove();
    mymap.locate();
    locating = false;
    console.log(200, 'done localizar');
    //mymap.locate({ setView: true, maxZoom: 16 });
  }

  // (2.4) ########## BOTÃO DO GPS ########## //
  function gpsbutton() {
    layer.remove();
    mymap.locate({ setView: true });
  }

  // (2.4) ########## CHAMANDO A FUNÇÃO LOCATE A CADA 15 SEGUNDOS... SEM PARAR ########## //
  setInterval(function(){allow_locating=true;localizar();allow_locating=false;}, 5000);

  // (2.4) ########## ADICIONANDO ENTRADA ########## //
  function adicionar_entrada2(local) {

    local_atual = L.latLng(local.lat, local.lng, local.alt); // TODO CRIAR CLONE AQUI
    local_atual.label = local.label;

    // console.log(205, local_atual);
    existe_entrada = false;
    // console.log(214, "entrei aqui 1", local_atual, existe_entrada, locais_entrados, locais_entrados.length);
    for (i = 0; i < locais_entrados.length; i++) {
      if (locais_entrados[i].saida == null) { // apenas se esta com entrada sem saida
        console.log(211, "entrei aqui 2", locais_entrados[i], local_atual);
        if (locais_entrados[i].distanceTo(local_atual) <= 200) {
          console.log(213, "entrei aqui 3");
          // já existe entrada, não fazer nada
          existe_entrada = true;
        }
      }
    }

    // console.log(219, locais_entrados.length);
    if (!existe_entrada && locais_entrados.length < 10) {
      // console.log(229, local_atual);
      local_atual.entrada = tempo();
      local_atual.saida = null;
      // console.log(290, local_atual, locais_entrados);
      locais_entrados.push(local_atual);
      // console.log(292, local_atual, locais_entrados);
    }
  }


  function adicionar_entrada(local_atual) {
    // d,h,m,xs = tempo();

    // verificar se já está dentro do local atual
    existe_entrada = false;
    console.log(214, "entrei aqui 1", local_atual);

    // for (i = 0; i < locais_entrados.length; i++) {
    //   if (local[i].saida == null) { // apenas se esta com entrada sem saida
    //     console.log(211, "entrei aqui 2");
    //     // if (local[i].distanceTo(cpos.distanceTo(local_atual)) <= 200) {
    //       console.log(213, "entrei aqui 3");
    //       // já existe entrada, não fazer nada
    //       existe_entrada = true;
    //     // }
    //   }
    // } 
    console.log(219, locais_entrados.length);
    if (!existe_entrada) {
      console.log(229);
      local_atual.entrada = tempo();
      local_atual.saida = null;
      lista.push(local_atual);
    }
  }

  // (2.4) ########## ADICIONANDO SAIDA ########## //

  function adicionar_saida(local_atual) {
    // verifica se existe um elemento na lista local do local_atual sem saida ainda
    for (i = 0; i < locais_entrados.length; i++) {
      if (locais_entrados[i].saida == null) { // apenas se esta com entrada sem saida
        if (cpos.distanceTo(locais_entrados[i]) > 200) {
          console.log(332, local_atual);
          locais_entrados[i].saida = tempo();
        }
      }
    }
  }

  // (3.0) ########## CONFIRMANDO DO LOCAL DA ZONA ########## //
  var popup = L.popup();

  function onMapClick(e) {
    if (confirm("Deseja definir como um lugar seguro?")) {
      nomedaZona(e);
    }

    else {

    }
  }

  mymap.on('click', onMapClick);

  // (3.1) ########## INSERINDO O NOME DA ZONA ########## //
  function nomedaZona(e) {
    var person = prompt("Insira o nome da zona:");
    if (person != null && person != "") {
      popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);

      var marcador = e.latlng;
      marcador.label = person;

      lista.push(marcador);
      localStorage.setItem("lista", JSON.stringify(lista));
      console.log(268, lista);

      L.marker(marcador).addTo(mymap)
        .bindPopup("<b>Zona segura</b>").openPopup();

      L.circle(marcador, 200, {
        color: 'green',
        fillColor: 'green',
        fillOpacity: 0.3
      }).addTo(mymap).bindPopup("<b>Dentro <strong>da</strong> zona de segurança.</b><br/>");
    }

    else {

    }
  }

  // (4.0) ########## LIMPANDO LOCAL STORAGE ########## //
  function limparStorage() {
    localStorage.clear('lista');
    location.reload();
  }

  // (5.0) ########## TEMPO ########## //
  function tempo() {
    return new Date();
    // today = new Date();
    // h = today.getHours();
    // m = today.getMinutes();
    // s = today.getSeconds();

    // console.log(h + ":" + m + ":" + s);
    // //setTimeout('tempo()', 500);
    // return (h,m,s);
  }

  // (6.0) ########## FULLSCREEN ########## //
  function requestFullScreen() {

    var el = document.body;

    // Supports most browsers and their versions.
    var requestMethod = el.requestFullScreen || el.webkitRequestFullScreen
      || el.mozRequestFullScreen || el.msRequestFullScreen;

    if (requestMethod) {

      // Native full screen.
      requestMethod.call(el);

    } else if (typeof window.ActiveXObject !== "undefined") {

      // Older IE.
      var wscript = new ActiveXObject("WScript.Shell");

      if (wscript !== null) {
        wscript.SendKeys("{F11}");
      }
    }
  }

  // (7.0) ########## ATIVADO E DESATIVADO ########## //
  var protegido = false;

  function cor_desprotegido() {
    console.log("red");
    document.getElementById("bola").style.backgroundColor = "red";
    document.getElementById("bola").style.borderColor = "red";
    document.getElementById("modo").style.color = "red";
    document.getElementById("modo").innerHTML = "Desativado";
    protegido = false;
  }

  function cor_protegido() {
    console.log("lime");
    document.getElementById("bola").style.backgroundColor = "lime";
    document.getElementById("bola").style.borderColor = "lime";
    document.getElementById("modo").style.color = "lime";
    document.getElementById("modo").innerHTML = "Ativado";
    protegido = true;
  }
</script>
</body>
</html>